<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AI Interview Prep - DataPal</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#00f2fe",
                        "primary-dark": "#0ea5e9",
                        "bg-dark": "#0B0C15",
                        "bg-card": "#151725",
                        "accent-purple": "#bd34fe",
                        "accent-pink": "#ff4b91",
                        "accent-lime": "#d9f99d",
                        "accent-yellow": "#fde047",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Outfit", "sans-serif"],
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 20px; }
        .glass-panel {
            background: rgba(21, 23, 37, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="bg-bg-dark text-slate-200 font-body overflow-hidden h-screen flex">

    <!-- Sidebar -->
    <aside class="w-20 lg:w-72 flex-shrink-0 flex flex-col justify-between border-r border-white/5 bg-bg-card">

        <div class="p-6 flex items-center gap-4">
            <div class="relative size-12 flex items-center justify-center bg-gradient-to-br from-accent-purple to-primary rounded-2xl text-white shadow-glow-purple">
                <span class="material-symbols-outlined text-3xl">smart_toy</span>
                <div class="absolute -top-1.5 -right-1.5 size-4 bg-accent-lime rounded-full border-4 border-bg-card"></div>
            </div>
            <div class="hidden lg:flex flex-col">
                <h1 class="text-2xl font-bold font-display text-white">DataPal</h1>
                <span class="text-[10px] text-primary font-bold uppercase tracking-widest">AI Interview Prep</span>
            </div>
        </div>
        <nav class="flex-1 px-4 py-6 flex flex-col gap-3">
            <button onclick="showSetup()" class="flex items-center gap-4 px-4 py-3.5 bg-gradient-to-r from-primary/20 to-transparent border-l-4 border-primary text-white rounded-r-2xl transition-all">
                <span class="material-symbols-outlined text-primary">chat_bubble</span>
                <span class="hidden lg:block font-bold text-sm">New Session</span>
            </button>
            <button onclick="resetChat()" class="flex items-center gap-4 px-4 py-3.5 text-slate-400 hover:text-white hover:bg-white/5 rounded-2xl transition-all">
                <span class="material-symbols-outlined">refresh</span>
                <span class="hidden lg:block font-medium text-sm">Reset</span>
            </button>
        </nav>
        <div class="p-6 border-t border-white/5">
            <div id="session-stats" class="text-xs text-slate-400 space-y-2 hidden">
                <div>Questions: <span id="stat-questions">0</span></div>
                <div>Avg Score: <span id="stat-score">0</span>%</div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-screen flex flex-col min-w-0 bg-bg-dark relative">

        <!-- Setup Screen -->
        <div id="setup-screen" class="flex-1 flex items-center justify-center p-8">
            <div class="w-full max-w-2xl glass-panel rounded-3xl p-10 shadow-2xl">
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold font-display text-white mb-3">Ready to Practice?</h2>
                    <p class="text-slate-400">Choose your preferences to start the interview session</p>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-white mb-3">Topic (Optional)</label>
                        <select id="topic-select" class="w-full bg-bg-dark border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary focus:ring-2 focus:ring-primary/20">
                            <option value="">Any Topic</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-white mb-3">Difficulty (Optional)</label>
                        <div class="flex gap-3">
                            <button onclick="selectDifficulty('')" class="difficulty-btn flex-1 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 transition-all">Any</button>
                            <button onclick="selectDifficulty('Beginner')" class="difficulty-btn flex-1 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 transition-all">Beginner</button>
                            <button onclick="selectDifficulty('Intermediate')" class="difficulty-btn flex-1 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 transition-all">Intermediate</button>
                            <button onclick="selectDifficulty('Advanced')" class="difficulty-btn flex-1 py-3 rounded-xl bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 transition-all">Advanced</button>
                        </div>
                    </div>
                    
                    <button onclick="startSession()" class="w-full py-4 bg-primary hover:bg-primary-dark text-black font-bold rounded-full transition-all shadow-glow flex items-center justify-center gap-2">
                        <span>Start Interview</span>
                        <span class="material-symbols-outlined">rocket_launch</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="hidden flex-1 flex flex-col h-full">
            <header class="h-20 px-6 lg:px-8 flex items-center justify-between border-b border-white/5 glass-panel">
                <div class="flex items-center gap-4">
                    <div class="size-10 rounded-xl bg-white/5 flex items-center justify-center text-accent-lime">
                        <span class="material-symbols-outlined">code</span>
                    </div>
                    <div>
                        <h2 id="session-topic" class="text-xl font-bold font-display text-white">Interview Session</h2>
                        <div class="flex items-center gap-2">
                            <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent-lime opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-accent-lime"></span>
                            </span>
                            <span class="text-xs font-medium text-slate-400">Active Session</span>
                        </div>
                    </div>
                </div>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 lg:p-8 space-y-6"></div>

            <div class="p-4 lg:p-6 bg-gradient-to-t from-bg-dark via-bg-dark to-transparent">
                <div class="max-w-4xl mx-auto">
                    <div class="flex gap-3 mb-4">
                        <button onclick="requestHint()" class="px-4 py-2 rounded-full bg-white/5 border border-white/10 text-xs font-bold text-accent-lime hover:bg-accent-lime hover:text-black transition-all">ðŸ’¡ Hint</button>
                        <button onclick="nextQuestion()" class="px-4 py-2 rounded-full bg-white/5 border border-white/10 text-xs font-bold text-primary hover:bg-primary hover:text-black transition-all">Next Question</button>
                    </div>
                    
                    <div class="relative">
                        <div class="flex items-center bg-bg-card border border-white/10 rounded-full p-2">
                            <input id="user-input" onkeypress="handleKeyPress(event)" class="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-slate-500 px-4 font-medium" placeholder="Type your answer..." type="text"/>
                            <button onclick="sendMessage()" class="px-6 h-12 rounded-full bg-primary hover:bg-primary-dark text-black font-bold flex items-center gap-2">
                                Send <span class="material-symbols-outlined text-[18px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedDifficulty = '';
        let messageCount = 0;

        // Load topics on page load
        window.onload = async () => {
            try {
                const res = await fetch('/api/topics');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('topic-select');
                    data.data.topics.forEach(topic => {
                        const opt = document.createElement('option');
                        opt.value = topic;
                        opt.textContent = topic;
                        select.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        };

        function selectDifficulty(level) {
            selectedDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-black', 'border-primary');
                btn.classList.add('bg-white/5', 'text-slate-300', 'border-white/10');
            });
            event.target.classList.remove('bg-white/5', 'text-slate-300', 'border-white/10');
            event.target.classList.add('bg-primary', 'text-black', 'border-primary');
        }

        async function startSession() {
            const topic = document.getElementById('topic-select').value;
            
            try {
                const res = await fetch('/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ topic: topic || null, difficulty: selectedDifficulty || null })
                });
                
                const data = await res.json();
                if (data.success) {
                    document.getElementById('setup-screen').classList.add('hidden');
                    document.getElementById('chat-screen').classList.remove('hidden');
                    
                    if (topic) document.getElementById('session-topic').textContent = `${topic} Interview`;
                    
                    addBotMessage(data.data.welcome_message);
                    addBotMessage(data.data.question.message);
                    
                    document.getElementById('session-stats').classList.remove('hidden');
                }
            } catch (error) {
                alert('Error starting session. Please try again.');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message })
                });
                
                const data = await res.json();
                if (data.success) {
                    addBotMessage(data.data.message);
                    updateStats();
                }
            } catch (error) {
                addBotMessage('Sorry, I encountered an error. Please try again.');
            }
        }

        async function requestHint() {
            try {
                const res = await fetch('/api/hint', {method: 'POST'});
                const data = await res.json();
                if (data.success) {
                    addBotMessage(data.data.message);
                }
            } catch (error) {
                console.error('Error requesting hint:', error);
            }
        }

        async function nextQuestion() {
            try {
                const res = await fetch('/api/next', {method: 'POST'});
                const data = await res.json();
                if (data.success) {
                    addBotMessage(data.data.message);
                }
            } catch (error) {
                console.error('Error getting next question:', error);
            }
        }

        async function resetChat() {
            if (confirm('Are you sure you want to reset the session?')) {
                try {
                    await fetch('/api/reset', {method: 'POST'});
                    location.reload();
                } catch (error) {
                    console.error('Error resetting chat:', error);
                }
            }
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('stat-questions').textContent = data.data.questions_asked;
                    document.getElementById('stat-score').textContent = data.data.average_score.toFixed(1);
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function showSetup() {
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function addUserMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'flex gap-4 max-w-3xl ml-auto justify-end';
            div.innerHTML = `
                <div class="bg-gradient-to-br from-accent-purple to-indigo-600 text-white p-4 rounded-2xl rounded-br-sm max-w-xl">
                    ${escapeHtml(text)}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addBotMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'flex gap-4 max-w-3xl';
            div.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="size-10 rounded-xl bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                </div>
                <div class="bg-bg-card p-4 rounded-2xl rounded-bl-sm border border-white/5 text-slate-200 max-w-2xl">
                    ${formatMarkdown(text)}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/â€¢ /g, '&bull; ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
